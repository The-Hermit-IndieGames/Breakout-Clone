using System;
using System.Collections;
using System.Collections.Generic;
using TMPro;
using UnityEngine;
using System.IO;
using UnityEngine.SceneManagement;


public class MainManager : MonoBehaviour
{
    //序列化==========================================================================================================================

    //序列化定義(設定)
    [Serializable]
    public class SettingRoot
    {
        public bool gameMusic;
        public float gameMusicF;
        public bool gameSoundEffect;
        public float gameSoundEffectF;

        public int effectsVFX;
        public int backgroundVFX;

        public float gameSpeedModifier;
    }

    //序列化定義(通關資訊)
    [Serializable]
    public class ClearDataRoot
    {
        public string name;
        public string version;
        public List<ClearLevel> clearLevel;
    }

    [Serializable]
    public class ClearLevel
    {
        public string levelID;
        public bool clear;
        public ClearData clearData;
    }

    [Serializable]
    public class ClearData
    {
        public int medalLevel;
        public int score;
        public int time;
        public float speed;
    }

    //序列化定義-關卡資料
    [Serializable]
    public class Root
    {
        //根目錄: 目錄名稱、製作者、版本號、描述、關卡列表(LevelConfig)
        public string name;
        public string maker;
        public string version;
        public string description;
        public List<LevelConfig> levelConfig;
        public int idCounter;
    }

    [Serializable]
    public class LevelConfig
    {
        //單一關卡資料: 關卡名稱、前置關卡ID、遊戲模式(Normal、?、?)、選關按鈕座標(x、y)、選關按鈕風格、磚塊列表(BricksData)
        public string levelID;
        public string levelName;
        public string[] preLevelID;
        public string nextLevelID;
        public string gameType;
        public float menuX;
        public float menuY;
        public int menuStyle;
        public List<BricksData> bricksData;
    }

    [Serializable]
    public class BricksData
    {
        //單一磚塊資料: 磚塊座標(x、y)、磚塊類型(Null、Normal、Unbreakable)、磚塊類型特有資料
        public int xPoint;
        public int yPoint;
        public string brickType;
        public NormalBricks normalBricks;
    }

    [Serializable]
    public class NormalBricks
    {
        //普通磚塊資料: 級別、道具
        public int brickLevel;
        public int powerUpType;
    }

    //靜態==========================================================================================================================

    //檔案
    [SerializeField] private TextAsset jsonDefaultLevels;
    public static Root[] levelConfigFiles;
    [SerializeField] private Root[] levelConfigFilesOnGUI;  //DeBug - 用於GUI預覽

    public static ClearDataRoot[] clearDataFiles;
    [SerializeField] private ClearDataRoot[] clearDataFilesOnGUI;  //DeBug - 用於GUI預覽

    //檔案ID (用於星圖生成)
    public static int nowFileId;
    public static ClearDataRoot nowClearDataFile;

    //關卡ID (用於關卡生成)
    public static string nowLevelId;
    public static LevelConfig nowLevelData;
    public static ClearLevel nowClearLevel;

    //讀檔用(關卡)
    public void LoadLevelConfigFiles()
    {
        string directoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "CustomLevels");

        if (!Directory.Exists(directoryPath))
        {
            Debug.LogError($"Directory not found: {directoryPath}");
            return;
        }

        string[] jsonFiles = Directory.GetFiles(directoryPath, "*.json");

        // i = 0  =>  預設關卡
        levelConfigFiles = new Root[jsonFiles.Length + 1];

        try
        {
            Root levelConfig = JsonUtility.FromJson<Root>(jsonDefaultLevels.text);
            levelConfigFiles[0] = levelConfig;
        }
        catch (Exception e)
        {
            Debug.LogError($"Failed to parse JSON file at jsonDefaultLevels : {e.Message}");
        }

        for (int i = 1; i <= jsonFiles.Length; i++)
        {
            string jsonContent = File.ReadAllText(jsonFiles[i - 1]);

            try
            {
                Root levelConfig = JsonUtility.FromJson<Root>(jsonContent);
                levelConfigFiles[i] = levelConfig;
            }
            catch (Exception e)
            {
                Debug.LogError($"Failed to parse JSON file at {jsonFiles[i - 1]}: {e.Message}");
            }
        }

        Debug.Log($"Loaded {levelConfigFiles.Length} level configuration files.");

        //該項僅用於開發預覽
        levelConfigFilesOnGUI = levelConfigFiles;
    }

    //讀檔用(過關資料)
    public void LoadClearDataFiles()
    {
        string directoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearData");

        if (!Directory.Exists(directoryPath))
        {
            Debug.LogWarning($"Directory not found: {directoryPath}");
            Directory.CreateDirectory(directoryPath);
        }


        string[] jsonFiles = Directory.GetFiles(directoryPath, "*.json");

        // i = 0  =>  預設關卡
        clearDataFiles = new ClearDataRoot[jsonFiles.Length + 1];

        try
        {
            // 預設關卡存放於 PlayerData/ClearLevelData.json
            string defaultDirectoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearLevelData.json");
            string defaultClearJson = File.ReadAllText(defaultDirectoryPath);
            ClearDataRoot defaultClearDataRoot = JsonUtility.FromJson<ClearDataRoot>(defaultClearJson);
            clearDataFiles[0] = defaultClearDataRoot;
        }
        catch (DirectoryNotFoundException)
        {
            Debug.LogWarning("異常: 未找到目錄");

            Debug.Log("建立目錄 " + "PlayerData");
            string folderPath = Path.Combine(Application.persistentDataPath, "PlayerData");
            Directory.CreateDirectory(folderPath);
            CreateClearDataFile("ClearLevelData");

            // 重新讀取
            string defaultDirectoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearLevelData.json");
            string defaultClearJson = File.ReadAllText(defaultDirectoryPath);
            ClearDataRoot defaultClearDataRoot = JsonUtility.FromJson<ClearDataRoot>(defaultClearJson);
            clearDataFiles[0] = defaultClearDataRoot;
        }
        catch (FileNotFoundException)
        {
            Debug.LogWarning("異常: 未找到文件");
            CreateClearDataFile("ClearLevelData");

            // 重新讀取
            string defaultDirectoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearLevelData.json");
            string defaultClearJson = File.ReadAllText(defaultDirectoryPath);
            ClearDataRoot defaultClearDataRoot = JsonUtility.FromJson<ClearDataRoot>(defaultClearJson);
            clearDataFiles[0] = defaultClearDataRoot;
        }
        finally
        {
            Debug.Log("已解析預設關卡紀錄");
        }

        for (int i = 1; i <= jsonFiles.Length; i++)
        {
            string jsonContent = File.ReadAllText(jsonFiles[i - 1]);

            try
            {
                ClearDataRoot clearDataRoot = JsonUtility.FromJson<ClearDataRoot>(jsonContent);
                clearDataFiles[i] = clearDataRoot;
            }
            catch (Exception e)
            {
                Debug.LogError($"Failed to parse JSON file at {jsonFiles[i - 1]}: {e.Message}");
            }
        }

        Debug.Log($"Loaded {clearDataFiles.Length} level configuration files.");

        //該項僅用於開發預覽
        clearDataFilesOnGUI = clearDataFiles;
    }

    //建立 ClearData 檔案
    private void CreateClearDataFile(string fileName)
    {
        Debug.Log("建立文件 " + "ClearLevelData.json");
        var newClearDataRoot = new ClearDataRoot();

        // 檔案路徑
        string exportFileName;
        if (fileName == "ClearLevelData")
        {
            //預設關卡
            exportFileName = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearLevelData.json");
            newClearDataRoot.name = levelConfigFiles[0].name;
        }
        else
        {
            //其他關卡
            exportFileName = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearData", "ClearLevelData_" + fileName + ".json");
            newClearDataRoot.name = fileName;
        }

        // 將Root轉換為JSON字符串
        string newClearDataJson = JsonUtility.ToJson(newClearDataRoot, true);

        // 將 JSON 字串寫入檔案
        File.WriteAllText(exportFileName, newClearDataJson);
    }

    //比對所有 ClearData 及 LevelConfig
    private void CompareAllClearData()
    {
        //比對"存在"
        for (int i = 1; i < levelConfigFiles.Length; i++)
        {
            bool haveClearData = false;
            for (int j = 1; i < clearDataFiles.Length; j++)
            {
                if (levelConfigFiles[i].name == clearDataFiles[j].name)
                {
                    haveClearData = true;
                    break;
                }
            }

            if (!haveClearData)
            {
                CreateClearDataFile(levelConfigFiles[i].name);
            }
        }

        //比對"版本"
        for (int i = 0; i < levelConfigFiles.Length; i++)
        {
            for (int j = 0; i < clearDataFiles.Length; j++)
            {
                if (levelConfigFiles[i].name == clearDataFiles[j].name)
                {
                    if (levelConfigFiles[i].version != clearDataFiles[j].version)
                    {
                        UpdateVersionClearData(i,j);
                    }

                    break;
                }
            }
        }
    }

    //比對單一 ClearData 版本
    private void UpdateVersionClearData(int levelID, int clearID)
    {
        clearDataFiles[clearID].version = levelConfigFiles[levelID].version;
        var levelConfig = levelConfigFiles[levelID].levelConfig;
        var clearLevel = clearDataFiles[clearID].clearLevel;

        foreach (var level in levelConfig)
        {
            bool haveData = false;
            foreach (var data in clearLevel)
            {
                if (level.levelID==data.levelID)
                {
                    haveData = true;
                }
            }

            if (!haveData)
            {
                var newClearLevel = new ClearLevel();
                newClearLevel.levelID = level.levelID;
                newClearLevel.clear = false;

                var newClearData = new ClearData();
                newClearData.medalLevel = 0;
                newClearLevel.clearData = newClearData;

                clearDataFiles[clearID].clearLevel.Add(newClearLevel);
            }
        }

        // 轉換為JSON字符串
        string clearDataFilesJson = JsonUtility.ToJson(clearDataFiles[clearID], true);

        // 確保目錄存在
        string directoryPath = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearData");
        Directory.CreateDirectory(directoryPath);

        // 檔案路徑
        string exportFileName;
        if (clearID == 0)
        {
            //預設關卡
            exportFileName = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearLevelData.json");
        }
        else
        {
            //其他關卡
            exportFileName = Path.Combine(Application.persistentDataPath, "PlayerData", "ClearData", "ClearLevelData_" + clearDataFiles[clearID].name + ".json");
        }

        // 寫入 JSON 到檔案
        File.WriteAllText(exportFileName, clearDataFilesJson);

        Debug.Log("通關資訊版本已更新並保存到 " + exportFileName);
    }


    //以 nowLevelId 尋找關卡
    public static void FindLevelConfigById()
    {
        foreach (var levelConfig in MainManager.levelConfigFiles[MainManager.nowFileId].levelConfig)
        {
            if (levelConfig.levelID == nowLevelId)
            {
                MainManager.nowLevelData = levelConfig;
            }
        }
    }

    //以 nowFileId 尋找過關檔案
    public static void FindClearDataFileById()
    {
        foreach (var clearDataFile in MainManager.clearDataFiles)
        {
            if (clearDataFile.name == MainManager.levelConfigFiles[MainManager.nowFileId].name)
            {
                MainManager.nowClearDataFile = clearDataFile;
            }
        }
    }

    //以 nowLevelId 尋找過關資料
    public static void FindClearLevelById()
    {
        foreach (var clearLevel in MainManager.nowClearDataFile.clearLevel)
        {
            if (clearLevel.levelID == nowLevelId)
            {
                MainManager.nowClearLevel = clearLevel;
            }
        }
    }

    //以 nowLevelData 及 nowClearLevel 檢查是否完成前置關卡
    public static bool CheckPreconditionById()
    {
        int preNumber = 0;
        for (int i = 0; i < nowLevelData.preLevelID.Length; i++)
        {
            foreach (var clearLevel in nowClearDataFile.clearLevel)
            {
                if (nowLevelData.preLevelID[i] == clearLevel.levelID && clearLevel.clear == true)
                {
                    preNumber++;
                }
            }
        }

        if (preNumber == nowLevelData.preLevelID.Length)
        {
            return true;
        }
        else
        {
            return false;
        }
    }

    //變數==========================================================================================================================

    //檔案
    [SerializeField] private TextAsset jsonSetting;

    //實例
    public SettingRoot settings;                                //設定  

    //腳本

    //預覽
    [SerializeField] private GameObject previewBrickPrefab;                 // 磚塊的預置體
    [SerializeField] private GameObject[] powerUpPrefabs;                   // 4種不同的預製件，分別代表type為1 - 4的預製件
    [SerializeField] private Transform previewBrickList;
    private int brickAmount;

    //音訊
    public AudioSource soundEffectUiTrue;
    public AudioSource soundEffectUiFalse;
    public AudioSource soundEffectUiPage;

    //運行
    public int nowLevel = 0;


    void Start()
    {
        //檔案
        jsonDefaultLevels = Resources.Load<TextAsset>("Data/DefaultLevels");

        //新版
        LoadLevelConfigFiles();
        LoadClearDataFiles();
        CompareAllClearData();

        //舊版
        LoadSettingsFromFile();

        UpdateAudio();
    }


    void Update()
    {

    }

    //資料操作==========================================================================================================================

    //資料操作-設定參數----------------------------------------------

    //初始化設定參數(並匯出)
    public void InitializationSettings()
    {
        Debug.LogWarning("初始化設定檔...");
        settings.gameMusic = true;
        settings.gameMusicF = 1.0f;
        settings.gameSoundEffect = true;
        settings.gameSoundEffectF = 1.0f;

        settings.effectsVFX = 20;
        settings.backgroundVFX = 500;

        settings.gameSpeedModifier = 1.0f;

        SaveSettingsToJson();
        Debug.Log("設定檔已初始化");
        Debug.Log("重新讀取設定檔...");
        string path = Path.Combine(Application.persistentDataPath, "PlayerData", "SettingFile.json");
        string json = File.ReadAllText(path);
        jsonSetting = new TextAsset(json);

        if (jsonSetting != null)
        {
            settings = JsonUtility.FromJson<SettingRoot>(jsonSetting.text);
            Debug.Log("[初始化]已成功載入設定參數");
        }
        else
        {
            Debug.LogWarning("[初始化]未找到設定參數檔");
        }
    }


    //讀取設定參數
    public void LoadSettingsFromFile()
    {
        Debug.Log("讀取設定檔...");
        string path = Path.Combine(Application.persistentDataPath, "PlayerData", "SettingFile.json");

        try
        {
            string json = File.ReadAllText(path);
            jsonSetting = new TextAsset(json);
        }
        catch (DirectoryNotFoundException)
        {
            Debug.LogWarning("異常: 未找到目錄");

            Debug.Log("建立目錄 " + "PlayerData");
            string folderPath = Path.Combine(Application.persistentDataPath, "PlayerData");
            Directory.CreateDirectory(folderPath);

            Debug.Log("建立文件 " + "SettingFile.json");
            InitializationSettings();
        }
        catch (FileNotFoundException)
        {
            Debug.LogWarning("異常: 未找到文件");

            Debug.Log("建立文件 " + "SettingFile.json");
            InitializationSettings();
        }
        finally
        {
            settings = JsonUtility.FromJson<SettingRoot>(jsonSetting.text);
            Debug.Log("已解析設定參數");
        }
    }


    //匯出設定參數 JSON
    public void SaveSettingsToJson()
    {
        Debug.Log("保存設定參數...");
        // 將SettingRoot轉換為JSON字符串
        string settingsjson = JsonUtility.ToJson(settings, true);

        // 檔案路徑
        string exportFileName = Path.Combine(Application.persistentDataPath, "PlayerData", "SettingFile.json");

        // 將 JSON 字串寫入檔案
        File.WriteAllText(exportFileName, settingsjson);

        Debug.Log("設定參數已保存到 " + exportFileName);
    }


    //更新音量大小
    public void UpdateAudio()
    {
        soundEffectUiTrue.volume = settings.gameSoundEffectF * 1.0f;
        soundEffectUiFalse.volume = settings.gameSoundEffectF * 2.0f;
        soundEffectUiPage.volume = settings.gameSoundEffectF * 1.0f;
    }


    //場景轉換==========================================================================================================================

    //接續(SelectLevelButton)-進入關卡
    public void EnterGameScene()
    {
        // 載入 GameScene
        SceneManager.LoadScene("GameScene");
    }


    //轉換場景
    void Awake()
    {
        //轉換場景時保留物件
        GameObject[] objs = GameObject.FindGameObjectsWithTag("DontDestroy");

        if (objs.Length > 1)
        {
            // 已經存在相同物件的實例，銷毀新的實例
            Destroy(gameObject);
        }

        DontDestroyOnLoad(gameObject);
    }

    //主場景==========================================================================================================================


    //設定介面==========================================================================================================================


    //音訊==========================================================================================================================



    //其他==========================================================================================================================
}
